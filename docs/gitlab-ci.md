# GitLab CI

This project includes a GitLab pipeline to run Agronomist using GitLab Runners.

## Requirements

- GitLab Runner with Docker or shell executor.
- GitLab token stored in GitLab CI variables.

## Variables

- `GITLAB_TOKEN` Token used by Agronomist for GitLab API calls and MR creation.
- `AGRONOMIST_VERSION` Agronomist release tag (e.g. `v0.5.0`).
- `AGRONOMIST_ROOT` Root directory to scan. Default: `.`
- `AGRONOMIST_RESOLVER` Resolver strategy: `git`, `github`, or `auto`.
- `AGRONOMIST_CONFIG` Path to configuration file (supports category rules and blacklist filters). Default: `.agronomist.yaml`.
- `MR_BODY` Merge Request description. Default: `Updates generated by Agronomist.`.
- `MR_TARGET_BRANCH` Target branch for MR. Default: `$CI_DEFAULT_BRANCH`.

**Note**: `MR_BRANCH` and `MR_TITLE` are generated dynamically using `CI_COMMIT_REF_SLUG` and `CI_PIPELINE_ID` to avoid conflicts.

## Pipeline overview

- `update` stage runs Agronomist, applies changes, and automatically creates a Merge Request if updates are found.
- **Workflow rules**: Only runs on `main` branch via manual trigger (web) or scheduled pipelines.
- **Dynamic branch naming**: Uses `CI_COMMIT_REF_SLUG` and `CI_PIPELINE_ID` to create unique MR branches and avoid conflicts.
- **Git configuration**: Automatically configures Git to use GitLab token for accessing private repositories.
- **MR cleanup**: Deletes existing MR branch before pushing to avoid conflicts when re-running the pipeline.
- **No report files**: Uses `--no-report` flag to keep the repository clean without generating report.json/report.md.

## Example pipeline

```yaml
stages:
  - update

workflow:
  name: "Agronomist"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == "main"'
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_COMMIT_REF_NAME == "main"'
    - when: never

variables:
  AGRONOMIST_VERSION: "v0.5.0"
  AGRONOMIST_ROOT: "."
  AGRONOMIST_RESOLVER: "git"
  AGRONOMIST_CONFIG: ".agronomist.yaml"
  MR_BODY: "Updates generated by Agronomist."
  MR_TARGET_BRANCH: "$CI_DEFAULT_BRANCH"

update:
  stage: update
  image: python:3.12
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == "main"'
      when: manual
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_COMMIT_REF_NAME == "main"'
      when: always
  script:
    - apt-get update -qq && apt-get install -y -qq git curl
    - |
      WHEEL="agronomist-${AGRONOMIST_VERSION#v}-py3-none-any.whl"
      curl -sSL -o "$WHEEL" "https://github.com/Ops-Talks/agronomist/releases/download/${AGRONOMIST_VERSION}/${WHEEL}"
      pip install -q "$WHEEL"
    - |
      if [ -n "$GITLAB_TOKEN" ]; then
        git config --global url."https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/".insteadOf "https://${CI_SERVER_HOST}/"
      fi
    - |
      MR_BRANCH="agronomist/updates-${CI_COMMIT_REF_SLUG}-${CI_PIPELINE_ID}"
      MR_TITLE="[Agronomist] - New modules version identified"
      export MR_BRANCH
      export MR_TITLE
    - |
      TOKEN_ARG=""
      if [ -n "$GITLAB_TOKEN" ]; then
        TOKEN_ARG="--gitlab-token $GITLAB_TOKEN"
      fi
      agronomist update --root "$AGRONOMIST_ROOT" \
        --config "$AGRONOMIST_CONFIG" \
        --resolver "$AGRONOMIST_RESOLVER" \
        --no-report \
        $TOKEN_ARG
    - |
      if [ -z "$GITLAB_TOKEN" ]; then
        echo "GITLAB_TOKEN not set. Skipping MR creation."
        exit 0
      fi

      if [ -z "$(git status --porcelain)" ]; then
        echo "No changes to commit."
        exit 0
      fi

      git config user.email "ci@agronomist"
      git config user.name "agronomist-bot"
      git checkout -b "$MR_BRANCH"
      git add -u
      git commit -m "$MR_TITLE"
      git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
      git push origin --delete "$MR_BRANCH" 2>/dev/null || true
      git push -u origin "$MR_BRANCH"

      curl --silent --show-error --fail \
        --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --form "source_branch=${MR_BRANCH}" \
        --form "target_branch=${MR_TARGET_BRANCH}" \
        --form "title=${MR_TITLE}" \
        --form "description=${MR_BODY}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests" || true
```

For a full pipeline, see [examples/workflows/.gitlab-ci.yml](https://github.com/ops-talks/agronomist/blob/main/examples/workflows/.gitlab-ci.yml).
