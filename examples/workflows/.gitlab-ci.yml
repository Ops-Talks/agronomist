stages:
  - update

workflow:
  name: "Agronomist"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == "main"'
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_COMMIT_REF_NAME == "main"'
    - when: never

variables:
  AGRONOMIST_VERSION: "v0.6.1"
  AGRONOMIST_ROOT: "."
  AGRONOMIST_RESOLVER: "git"
  AGRONOMIST_CONFIG: ".agronomist.yaml"
  MR_BODY: "Updates generated by Agronomist."
  MR_TARGET_BRANCH: "$CI_DEFAULT_BRANCH"

update:
  stage: update
  image: python:3.12
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == "main"'
      when: manual
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_COMMIT_REF_NAME == "main"'
      when: always
  script:
    - apt-get update -qq && apt-get install -y -qq git curl jq
    - |
      WHEEL="agronomist-${AGRONOMIST_VERSION#v}-py3-none-any.whl"
      curl -sSL -o "$WHEEL" "https://github.com/Ops-Talks/agronomist/releases/download/${AGRONOMIST_VERSION}/${WHEEL}"
      pip install -q "$WHEEL"
    - |
      if [ -n "$GITLAB_TOKEN" ]; then
        git config --global url."https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/".insteadOf "https://${CI_SERVER_HOST}/"
      fi
    - |
      TOKEN_ARG=""
      if [ -n "$GITLAB_TOKEN" ]; then
        TOKEN_ARG="--gitlab-token $GITLAB_TOKEN"
      fi
      agronomist update --root "$AGRONOMIST_ROOT" \
        --config "$AGRONOMIST_CONFIG" \
        --resolver "$AGRONOMIST_RESOLVER" \
        --output report.json \
        $TOKEN_ARG
    - |
      set +e

      if [ -z "$GITLAB_TOKEN" ]; then
        echo "GITLAB_TOKEN not set. Skipping MR creation."
        exit 0
      fi

      if [ ! -f "report.json" ]; then
        echo "No report.json found."
        exit 0
      fi

      if [ -z "$(git status --porcelain)" ]; then
        echo "No changes to commit."
        exit 0
      fi

      git config user.email "ci@agronomist"
      git config user.name "agronomist-bot"
      git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"

      # Extract unique modules from report.json
      modules=$(jq -r '.updates[].module' report.json 2>/dev/null | sort -u)

      if [ -z "$modules" ]; then
        echo "No modules found in report.json"
        exit 0
      fi

      # Ensure we're on a proper branch (not detached HEAD)
      base_branch="$CI_COMMIT_REF_NAME"
      echo "Base branch: $base_branch"

      # Fetch and checkout the branch properly
      git fetch origin "$base_branch"
      git checkout -B "$base_branch" "origin/$base_branch"

      # Preserve report.json (don't include it in git)
      cp report.json /tmp/report.json

      # Create a temporary commit with all changes (excluding report.json and wheel)
      git add providers/
      git commit -m "[agronomist] temporary commit with all module updates"
      all_changes_commit=$(git rev-parse HEAD)

      # Reset to the state before changes
      git reset --hard HEAD~1

      # Restore report.json
      cp /tmp/report.json report.json

      for module in $modules; do
        echo "Processing module: $module"

        # Create branch name from module
        branch_name="agronomist/update-$(echo "$module" | sed 's/\//-/g')"
        echo "Branch name: $branch_name"

        # Get files affected by this module
        echo "Fetching files for module..."
        files=$(jq -r --arg mod "$module" '.updates[] | select(.module==$mod) | .files[]' report.json 2>&1) || {
          echo "Error running jq for module: $module"
          echo "jq output: $files"
          continue
        }

        if [ -z "$files" ]; then
          echo "No files found for module: $module"
          continue
        fi

        echo "Files to update:"
        echo "$files"

        # Ensure we're on the base branch
        echo "Checking out base branch: $base_branch"
        git checkout "$base_branch" || {
          echo "Failed to checkout base branch"
          continue
        }
        # Restore report.json after checkout
        cp /tmp/report.json report.json

        # Delete local branch if it exists
        git branch -D "$branch_name" 2>/dev/null || true

        # Create and checkout new branch from clean state
        echo "Creating new branch: $branch_name"
        git checkout -b "$branch_name" || {
          echo "Failed to create branch: $branch_name"
          continue
        }

        # Cherry-pick only the files for this module from the temp commit
        echo "Cherry-picking files..."
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            echo "  Checking out: $file"
            git checkout "$all_changes_commit" -- "$file" || echo "  Failed to checkout: $file"
          fi
        done <<< "$files"

        # Check if there are changes
        if [ -z "$(git diff --cached --name-only)" ] && [ -z "$(git diff --name-only)" ]; then
          echo "No changes for module: $module"
          git checkout "$base_branch"
          cp /tmp/report.json report.json
          git branch -D "$branch_name" 2>/dev/null || true
          continue
        fi

        # Stage and commit changes
        echo "Committing changes..."
        git add providers/
        git commit -m "[Agronomist] There is a new Module Version" || {
          echo "Failed to commit changes"
          git checkout "$base_branch"
          cp /tmp/report.json report.json
          git branch -D "$branch_name" 2>/dev/null || true
          continue
        }

        # Delete remote branch if exists and push
        echo "Pushing to remote..."
        git push origin --delete "$branch_name" 2>/dev/null || true
        git push -u origin "$branch_name" || {
          echo "Failed to push branch: $branch_name"
          git checkout "$base_branch"
          cp /tmp/report.json report.json
          git branch -D "$branch_name" 2>/dev/null || true
          continue
        }

        # Create MR
        echo "Creating merge request..."
        curl --silent --show-error --fail \
          --request POST \
          --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
          --form "source_branch=${branch_name}" \
          --form "target_branch=${MR_TARGET_BRANCH}" \
          --form "title=[Agronomist] Update ${module}" \
          --form "description=${MR_BODY}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests" || echo "Failed to create MR"

        # Return to base branch for next iteration
        echo "Returning to base branch..."
        git checkout "$base_branch"
        cp /tmp/report.json report.json
        echo "Module $module completed successfully"
        echo "---"
      done

      # Clean up local branches
      for module in $modules; do
        branch_name="agronomist/update-$(echo "$module" | sed 's/\//-/g')"
        git branch -D "$branch_name" 2>/dev/null || true
      done
